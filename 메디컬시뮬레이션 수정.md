# 안과 메디컬 메뉴: “교정 전후” AR 시뮬레이션 전환 구현 계획 (MVP)

## 0) 목표
기존 피부과 메디컬 메뉴(결·톤 정돈, 표정주름 완화 등)를 **안과 전용 “교정 전후” 시뮬레이션**으로 교체한다.  
모바일/웹캠 환경에서는 **Live(카메라)** 로 체험, PC 등 카메라가 없으면 **Sample(샘플 이미지)** 로 자동 전환한다.

- 메뉴 버튼 2개(필수)
  1) **교정 전후(라식/라섹)**
  2) **교정 전후(녹내장/백내장)**

> 주의(표현/컴플라이언스): “치료/확진/검사 필요” 등 단정 표현은 금지.  
> 본 기능은 “참고용 시각화/체감 시뮬레이션”이며 실제 결과를 예측/보장하지 않음을 고정 안내한다.

---

## 1) UX / IA (화면 구성)

### 1.1 메디컬 메뉴 진입
- 모달 타이틀: **가상 시뮬레이션(참고용)**
- 서브타이틀: “어떤 교정 전후가 궁금하세요?”
- 카드 2개(기존 4개 카드 교체)

#### 카드 A
- 라벨: **교정 전후(라식/라섹)**
- 설명(작게): “또렷함/번짐 체감 비교”

#### 카드 B
- 라벨: **교정 전후(녹내장/백내장)**
- 설명(작게): “대비/안개·눈부심 체감 비교”

### 1.2 시뮬레이터 화면(공통)
- 상단: `교정 전후 보기` 토글 + 현재 상태 라벨  
  - **교정 전(기본)** / **교정 후(설정)**
- 탭: 샘플 선택(카메라 없을 때 기본)
  - `야간 도로` `글자/간판` `실내 화면` `밝은 야외`
- 프리셋(선택) + 슬라이더(세부)
- 하단 CTA: **“이 설정을 저장하기(로그인)”** (이미 로그인 상태면 “저장하기”)

### 1.3 Live/Sample 모드 전환
- 카메라 권한 성공: **Live 모드**(웹캠 스트림)
- 권한 거부/기기 미지원: 자동 **Sample 모드**
- 상단 토스트:
  - Live: “웹캠으로 체험 중(저장되지 않음)”
  - Sample: “샘플로 체험 중(카메라 없이 가능)”

---

## 2) 시뮬레이션 정의(핵심: “교정 전/후” 의미 고정)

### 2.1 공통 원칙
- **교정 전(기본)**: 원본(필터 미적용)
- **교정 후(설정)**: 현재 선택된 프리셋/슬라이더 적용 결과
- “교정”은 시술 결과 예측이 아니라 **시각적 체감 비교(설정 기반)**임을 UI에 고정

고정 디스클레이머(필수):
- “본 기능은 참고용 체감 시뮬레이션이며, 실제 상태·결과를 예측하거나 보장하지 않습니다.”

---

## 3) 기능 사양

### 3.1 메뉴 A: 교정 전후(라식/라섹)
**의도:** “또렷함/번짐” 체감 중심의 Before/After 비교

- 기본 프리셋(권장): `clear` 또는 `blur` 반대 체감
- 사용자 조절:
  - 흐림(blur): 0 ~ 1
  - 대비(contrast): -0.3 ~ +0.3
  - (옵션) 샤프닝(sharpness): 0 ~ 1 (WebGL 사용 시)

권장 기본값(샘플별):
- 글자/간판: blur 0.25, contrast +0.08
- 실내 화면: blur 0.15, contrast +0.05
- 밝은 야외: blur 0.10, contrast +0.03
- 야간 도로: blur 0.18, contrast +0.04

### 3.2 메뉴 B: 교정 전후(녹내장/백내장)
**의도:** “대비 저하/안개/눈부심” 체감 중심의 Before/After 비교

- 핵심 효과:
  - 안개(mist): blur + 대비 감소 조합
  - 눈부심(glare): bloom/halo 유사 효과(간단히는 밝기 영역 확산)
  - 대비(contrast): -0.3 ~ +0.3

권장 기본값(샘플별):
- 야간 도로: glare 0.55, blur 0.18, contrast +0.06
- 밝은 야외: glare 0.35, blur 0.12, contrast -0.05
- 글자/간판: blur 0.22, contrast -0.08
- 실내 화면: glare 0.18, blur 0.10, contrast -0.06

> 구현 난이도 낮추기: glare는 “밝은 영역을 마스크로 잡아 가우시안 블러로 확산” 정도로도 충분히 체감 가능.

---

## 4) 컴포넌트/파일 구조(Next.js App Router)

### 4.1 기존 피부과 모달 교체
- [MODIFY] `MedicalSimulationModal.tsx` (또는 기존 모달 컴포넌트명)
  - 카드 4개 → 카드 2개로 교체
  - 선택 시 `OphthalSimulator`로 라우팅/스왑

### 4.2 신규/재사용 컴포넌트
- [NEW] `components/medical/ophthal/OphthalSimulationMenu.tsx`
  - 두 메뉴 카드 렌더
- [NEW] `components/medical/ophthal/OphthalVisionSimulator.tsx`
  - Canvas 기반 렌더(Live/Sample 공용)
  - 상태: mode, category, viewMode, preset, blur, glare, contrast, sampleSrc
- [MODIFY] `PhotoSlideOver.tsx` 또는 메디컬 모달 내 콘텐츠 교체
  - 기존 피부과 UI 제거 후 위 컴포넌트 연결

### 4.3 타입
- [NEW] `lib/types/ophthal-sim.ts`
```ts
export type OphthalCategory = "lasik" | "cataract";
export type VisionMode = "live" | "sample";
export type ViewMode = "before" | "after";
export type VisionPreset = "clear" | "blur" | "glare" | "mist";

export interface VisionState {
  category: OphthalCategory;
  mode: VisionMode;
  viewMode: ViewMode;          // before/after
  preset: VisionPreset;
  blur: number;                // 0~1
  glare: number;               // 0~1
  contrast: number;            // -0.3~0.3
  sampleSrc?: string;
}
5) 샘플 이미지(카메라 없는 PC 대응)
경로:

public/samples/vision/

street_night.jpg

text_board.jpg

office_screen.jpg

street_day.jpg

동작:

카메라 미지원/권한 거부 시 자동 Sample 모드로 전환

샘플 탭 선택 시 sampleSrc 변경 → Canvas 재렌더

6) “교정 전후” 비교 UX(필수)
6.1 토글
버튼: 교정 전후 보기

라벨: 교정 전(기본) / 교정 후(설정)

기본값: 교정 후(설정)

6.2 “누르고 비교”(추천)
버튼 누름: 교정 전(기본)

버튼 뗌: 교정 후(설정)

모바일/PC 모두 Pointer Events로 통일

7) 이벤트 / 저장(전환 트리거)
7.1 이벤트(필수)
medical_sim_open { category }

sim_mode_switch { mode }

sim_sample_select { sample }

sim_preset_change { preset }

sim_slider_change { blur, glare, contrast }

sim_before_after_toggle { viewMode }

cta_save_click { category }

7.2 저장(로그인 연동)
저장 대상: 이미지 저장 금지, 설정값만 저장

API:

POST /api/eye/result/upsert

payload 예시:

json
코드 복사
{
  "session_id": "uuid",
  "menu_slug": "medical_sim",
  "inputs": {
    "category": "lasik",
    "sample": "street_night",
    "preset": "glare",
    "blur": 0.18,
    "glare": 0.55,
    "contrast": 0.06,
    "viewModeLabels": "교정 전(기본)/교정 후(설정)"
  }
}
8) 컴플라이언스 가이드(메디컬 영역)
금지: 치료/확진/검사 필요(단정)/위험(단정)

허용: 참고용, 체감, 비교, 설정, 요약, 상담용 정리

고정 문구:

“참고용 시뮬레이션이며 실제 결과를 예측/보장하지 않습니다.”

9) Verification Plan
메디컬 모달에서 메뉴 2개가 표시되는지 확인(기존 피부과 카드 제거)

각 메뉴 선택 시 시뮬레이터가 열리는지 확인

카메라 권한 허용 → Live 모드 동작 확인

카메라 없음/거부 → Sample 모드 자동 전환 확인

교정 전(기본)/교정 후(설정) 토글 및 누르고 비교 정상 동작

샘플 탭/프리셋/슬라이더 변경 시 Canvas에 반영 확인

저장(로그인) 클릭 시 설정값만 DB에 저장되는지 확인

고정 디스클레이머 문구 노출 확인

yaml
코드 복사
