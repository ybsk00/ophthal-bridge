# 헬스케어 채팅 → 로그인 후 메디컬 상담(자동 시작) 전환 트리거 설계

## 0) 목표
헬스케어 세션에서 사용자가 채팅/시뮬레이션을 진행하면,
**분석 결과(상담용 요약)**는 로그인 이후 메디컬 창으로 넘겨
메디컬 상담이 “자연스럽게” 이어지도록 한다.

- 1퍼널(헬스케어): 참여/체감/기록 중심 (단정/확정 금지)
- 2퍼널(메디컬): 로그인 후 요약 리포트 기반 상담 시작 + 상담 신청 전환

---

## 1) 전체 흐름(권장)
1) 헬스케어 채팅 시작(비로그인)
2) 사용자가 “불편 상황”을 고르거나(야간/글자/실내/야외),
   시뮬레이터에서 프리셋/슬라이더를 조정
3) 헬스케어 종료 화면에서 “요약이 준비됨” 티저 노출(수치/단정 없이)
4) [CTA] “요약 저장하고 이어서 보기(로그인)”
5) 로그인 성공 → 메디컬 페이지로 리다이렉트(`/medical?sessionId=...`)
6) 메디컬 화면에서 “상담용 요약 카드” 자동 노출 + 첫 질문 자동 시작
   - 예: “지금 시야에서 불편하게 느껴지는 상황이 있으신가요?”

---

## 2) 트리거 설계(헬스케어 → 메디컬)
### 2.1 트리거 조건(행동 기반)
아래 중 하나라도 만족하면 전환 CTA를 강하게 노출:
- 시뮬레이터 프리셋 변경 ≥ 2회
- 슬라이더 조정 ≥ 3회
- 샘플 탭 변경 ≥ 2회
- 채팅 메시지 ≥ 3턴(질문/답 포함)
- 체류 시간 ≥ 12초

### 2.2 헬스케어 종료 티저(로그인 전 허용 문구)
- “관리 포인트가 몇 가지 정리되었습니다.”
- “지금까지 진행한 내용을 ‘상담용 요약’으로 저장할 수 있어요.”
- “저장하면 메디컬 창에서 바로 이어서 상담이 시작됩니다.”

금지(로그인 전):
- 점수/단계(0~100, 1~5) 노출
- 단정 표현(위험, 검사 필요, 확진 등)

---

## 3) 데이터 핸드오프(세션/요약 구조)
### 3.1 세션 생성(비로그인)
- `POST /api/eye/session/start`
- 응답: `session_id`, `anon_id`

### 3.2 헬스케어 진행 중 임시 저장(서버)
- `POST /api/eye/event`
- 이벤트로 누적:
  - chat_turn (사용자 입력 요약본/태그)
  - simulator_interaction (preset, sliders, sample)
  - topic_selected (불편 상황 선택)

### 3.3 로그인 성공 후 이관
- 로그인 콜백에서 `session_id`를 받아
  - `eye_sessions.user_id` 연결
  - `eye_sessions.converted_at` 기록
- 그리고 `POST /api/eye/result/upsert`로 “상담용 요약(summary)” 저장

> 원칙: 민감한 원문 텍스트/이미지 저장 최소화.
> 저장은 “태그/선택값/설정값/요약문(짧게)” 위주.

---

## 4) “상담용 요약(summary)” 포맷(권장)
메디컬 상담이 시작될 때 첫 질문을 만들 수 있어야 한다.

예시(JSON):
```json
{
  "context": {
    "primary_situation": "야간 도로",
    "secondary_situation": "글자/간판",
    "user_goal": "체감 비교"
  },
  "simulator": {
    "preset": "glare",
    "blur": 0.18,
    "glare": 0.55,
    "contrast": 0.06,
    "beforeAfterLabel": "교정 전(기본)/교정 후(설정)"
  },
  "chat_tags": [
    "야간에 불편함 언급",
    "글자 선명도 관심",
    "눈부심 체감 선택"
  ],
  "handoff_note": "야간 불빛과 글자 선명도에서 체감 비교를 진행했습니다."
}
