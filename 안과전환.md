# Ophthal-Bridge (Phase 1) — 안과 헬스케어 메뉴 구현 계획 (Anti-Gravity 작업용)
> 스택: Next.js(App Router) + React + Supabase(Auth/DB/Storage)  
> 목표: **비로그인 1퍼널(참여)** → **로그인 게이트(전환)** → **로그인 후 결과 리포트(2퍼널 CTA)**  
> 핵심 원칙: **진단/처방/스크리닝 금지**, “참고용 컨디션 지수/자가 체크”로만 표현

---

## 0. 구현 범위(이번 작업)
### 포함(In)
- 모바일 웹(반응형) 기반 **헬스케어 메뉴 5종**
- 비로그인 상태로 테스트 진행(퍼널1)
- 결과 페이지: 로그인 전 **티저 + 블러 게이트**
- 로그인 후: **상세 결과 리포트 + CTA(상담/예약/쿠폰)**
- 관리자(간단): 유입/완료/로그인/CTA 클릭 통계
- Supabase RLS 기반 데이터 보호

### 제외(Out)
- 의료적 확정/진단/질환 판정
- 의학적 효력 있는 수치(“눈 나이 58세” 같은 판정형 표현 금지)
- 서버 딥러닝 추론/학습(Phase 1은 Rule-based 중심)
- 의료기기 연동(안압/망막/동공 정밀 등)

---

## 1. UX 플로우 (Dual Funnel)
### 1.1 Funnel 1 (비로그인)
1) `/eye-care` 랜딩 → 메뉴 선택  
2) 테스트 진행(설문/터치/간단 반응)  
3) 완료 화면: **티저(비수치) + 결과 블러 + 로그인 CTA**

**로그인 전 노출 허용(티저 예시)**
- “5개 항목 중 4개 분석 완료”
- “관리 포인트 2개가 발견됐어요”
- “리포트 저장 후 상세 결과 확인”

**로그인 전 금지**
- 질환명 직접 연결(백내장/녹내장/황반변성 등)
- ‘검사 필요/위험/진단’ 단정
- 점수/등급/판정 수치 노출(블러 처리)

### 1.2 Funnel 2 (로그인 후)
1) OAuth 로그인 완료  
2) `/eye-care/result/[session_id]`에서 블러 해제  
3) 결과: **컨디션 지수/경향성/생활 가이드(참고용)**  
4) CTA: “상담 예약”, “검진 쿠폰”, “병원 안내” 등

---

## 2. 메뉴 5종 정의 (용어 안전 버전)
> 공통 출력: “본 결과는 참고용 자가 체크이며 의학적 진단이 아닙니다. 불편이 지속되면 전문가 상담이 도움이 될 수 있습니다.”

### M1. 눈 컨디션 지수 (Eye Condition Score)
- 입력: 나이대(선택), 주간/야간 사용 습관, 근거리 작업 빈도, 불편 빈도(0~4)
- 로직: 가중치 합산 → 0~100 점수
- 결과: “컨디션 지수”, “최근 습관 기반 경향” + 생활 팁 3개

### M2. 건조 체감 지수 (Dryness Index)
- 입력: OSDI 변형 6~8문항(가중치), 렌즈 사용 여부, 실내 환경(난방/에어컨)
- 옵션: 타이머 기반 “깜빡임 챌린지(선택)”(카메라 없이도 진행 가능)
- 결과: 4단계(낮음/보통/높음/매우높음) **(질환 단어 금지)**

### M3. 시야 패턴 체크 (Amsler-style Experience)
- 명칭에서 “스크리닝/황반변성/난시” 단어 사용 금지
- 구현: Canvas 격자/방사형 선을 보여주고 사용자가 “왜곡 느낀 구역”을 터치/드래그
- 로직: 터치 영역 면적/횟수 기반 “체감 패턴 점수”
- 결과: “시야 패턴 참고 기록” + “불편 지속 시 상담 권장(완곡)”

### M4. 디지털 피로 지수 (Digital Eye Strain)
- 입력: 스크린타임, 야간사용, 휴식 주기(20-20-20), 두통/뻑뻑함 빈도
- 로직: 1~5 레벨 + 0~100 점수 병기(선택)
- 결과: “피로 경향”, “개선 루틴(3가지)”

### M5. 눈 라이프스타일 타입 (Eye-Q Lifestyle)
- 입력: 수면/식습관/실내활동/야외활동/운동 빈도
- 로직: 캐릭터 매핑(예: “야간 부엉이형”, “실내 건조형” 등) + 영양/습관 팁
- 결과: 재미 + 공유 유도(단, 과장 금지)

---

## 3. 기술 아키텍처 (Next.js + Supabase)
### 3.1 프론트엔드(Next.js App Router)
- `/eye-care` : 헬스케어 홈(메뉴 5개)
- `/eye-care/test/[slug]` : 메뉴별 테스트 화면
- `/eye-care/gate/[session_id]` : 티저 + 블러 + 로그인 유도
- `/eye-care/result/[session_id]` : 로그인 후 결과 리포트
- `/admin/eye-care` : 통계 대시보드(간단)

### 3.2 로그인(Supabase Auth)
- Supabase Auth OAuth 사용(가능한 프로바이더 우선 적용)
- 만약 특정 소셜(예: 네이버 등)이 Auth에서 직접 지원이 제한되면:
  - (옵션 A) NextAuth(OAuth)로 로그인 후 Supabase Custom JWT/연동
  - (옵션 B) 로그인은 이메일/카카오 등 MVP 가능한 수단만 우선

> MVP 원칙: **로그인 마찰 최소화(원탭)** + 프로바이더는 “가능한 것부터”.

### 3.3 점수 계산(Phase 1 Rule-based)
- 모든 계산은 클라이언트에서 수행(즉시 응답)
- 서버에는 “입력 요약 + 결과 점수 + 이벤트 로그”만 저장
- OpenCV.js는 Phase 1에서 **옵션(Off by default)**: 기기/권한 이슈가 크면 미적용

---

## 4. DB 설계 (Supabase / PostgreSQL)
> 네이밍은 예시. 실제 프로젝트 컨벤션에 맞춰 통일.

### 4.1 테이블
#### `profiles`
- `id uuid (pk, auth.users.id fk)`
- `created_at timestamptz`
- `marketing_opt_in boolean`
- `phone text nullable` (필요 시)
- `source text nullable` (utm_source 등)

#### `eye_sessions`
- `id uuid (pk)`
- `anon_id text` (비로그인 식별자; localStorage에 저장)
- `user_id uuid nullable` (로그인 후 연결)
- `entry_path text` (2030/4050/office 등)
- `utm jsonb`
- `created_at timestamptz`
- `converted_at timestamptz nullable` (로그인 성공 시각)

#### `eye_test_results`
- `id uuid (pk)`
- `session_id uuid (fk eye_sessions.id)`
- `menu_slug text` (condition/dryness/pattern/strain/lifestyle)
- `inputs jsonb` (민감정보 최소화: 설문 점수/선택 값 위주)
- `score int` (0~100)
- `level text` (LOW/MID/HIGH 등)
- `summary jsonb` (리포트에 필요한 문장 키/추천 키워드)
- `created_at timestamptz`

#### `eye_events`
- `id bigserial (pk)`
- `session_id uuid`
- `user_id uuid nullable`
- `event_name text`  
  - 예: `landing_view`, `test_start`, `test_complete`, `gate_view`, `login_click`, `login_success`, `result_view`, `cta_click`
- `props jsonb`
- `created_at timestamptz`

#### `consult_requests`
- `id uuid (pk)`
- `user_id uuid`
- `session_id uuid`
- `name text`
- `phone text`
- `preferred_time text nullable`
- `memo text nullable`
- `created_at timestamptz`
- `status text` (NEW/CONTACTED/DONE)

### 4.2 RLS 정책(핵심)
- `eye_sessions`: `user_id = auth.uid()` 인 행만 읽기 허용(로그인 후)
- 비로그인 단계에서는 DB에 쓰지 않거나, `anon_id` 기반으로 제한된 write-only 패턴 사용
- `eye_test_results`: session 소유자만 읽기
- `consult_requests`: 사용자 본인 + 관리자만 읽기

> MVP 권장: **비로그인 데이터는 DB 저장 최소화**  
> (LocalStorage → 로그인 후 서버 업서트)

---

## 5. Deferred Registration(지연 등록) 구현 방식
### 5.1 클라이언트 저장
- `anon_id`: 최초 방문 시 생성(UUID) → localStorage 저장
- `session_id`: 테스트 시작 시 생성 → localStorage 저장
- 메뉴별 입력/결과는 localStorage에 임시 저장(30분 TTL 개념으로 만료 처리)

### 5.2 로그인 후 이관
- 로그인 성공 시:
  1) localStorage의 `session_id`를 서버로 전송
  2) 서버에서 `eye_sessions.user_id` 업데이트 + `converted_at` 기록
  3) localStorage의 임시 결과를 `eye_test_results`로 업서트
  4) `/eye-care/result/[session_id]`로 이동

---

## 6. API 라우트(Next.js Route Handlers) 제안
- `POST /api/eye/session/start`
  - anon_id, entry_path, utm 저장 → session_id 반환
- `POST /api/eye/result/upsert`
  - session_id, menu_slug, inputs, score, level, summary 저장
- `POST /api/eye/event`
  - event_name, props 기록
- `POST /api/consult/request`
  - 상담 신청 저장

> 서버는 “검증/저장/권한” 중심. 점수 계산은 클라에서.

---

## 7. UI 컴포넌트 구조(React)
- `EyeCareLanding`
- `EyeMenuCard`
- `TestShell` (Progress, Disclaimer Sticky, Exit 방지)
- `QuestionCard` / `ChoiceGrid`
- `FakeLoading` (정직한 문구만)
- `GateBlurCard` (티저 + 소셜 로그인 CTA)
- `ResultReport`
  - `ScoreGauge`
  - `TrendCard`
  - `TipsList`
  - `CTASection`
- `ConsentBanner` (저장/동의 안내)

---

## 8. 문구/컴플라이언스 가이드(강제 룰)
### 금지 단어(대표)
- 진단, 처방, 치료, 환자, 스크리닝, 확진, 검사 필요(단정), 위험(단정), 완치

### 권장 대체
- 자가 체크, 참고용, 컨디션, 경향, 가이드, 사용 습관, 상담이 도움될 수 있음

### 고정 디스클레이머(결과 상단 + 하단)
- “본 결과는 참고용 자가 체크이며 의학적 진단이 아닙니다.”
- “불편이 지속되거나 악화되면 전문가 상담을 권장합니다.”

---

## 9. 분석/지표 이벤트 설계(KPI 연결)
필수 이벤트:
- `landing_view`
- `test_start(menu_slug)`
- `test_complete(menu_slug)`
- `gate_view`
- `login_click(provider)`
- `login_success`
- `result_view`
- `cta_click(type=consult/coupon/call)`
- `consult_submit`

KPI 산식:
- 완료율 = test_complete / test_start
- 가입전환율 = login_success / test_complete
- 리드CVR = consult_submit / result_view
- CTA CTR = cta_click / result_view

---

## 10. 4주 MVP 작업 계획
### Week 1
- 5개 메뉴 시나리오/질문지 확정(점수 수식 포함)
- UI 와이어 + 문구 필터링 확정
- Supabase 프로젝트/테이블/RLS 세팅

### Week 2
- `/eye-care` + 5개 테스트 화면 구현
- localStorage 기반 세션/진행 저장
- 이벤트 로깅(클라)

### Week 3
- 소셜 로그인 연동(가능한 프로바이더부터)
- 로그인 후 이관(Deferred Registration)
- 결과 리포트 UI(차트/게이지/팁)

### Week 4
- 관리자 통계(기본 지표)
- QA(모바일 권한/브라우저 호환/이탈 케이스)
- GA4/Pixel 연동 및 배포

---

## 11. 체크리스트(런칭 전)
- [ ] 로그인 전 결과 수치/등급 노출 없음(블러/티저만)
- [ ] 질환명/스크리닝 표현 제거(특히 메뉴명/설명)
- [ ] 디스클레이머 상단/하단 고정
- [ ] RLS 정상 동작(타 사용자 데이터 접근 불가)
- [ ] localStorage 만료/복구(뒤로가기/새로고침) 처리
- [ ] CTA 클릭 → 상담 폼/쿠폰 발급 정상
- [ ] 이벤트 로그로 KPI 산출 가능

---

## 12. 파일/폴더 구조 예시(Next.js)
app/
  eye-care/
    page.tsx
    test/[slug]/page.tsx
    gate/[sessionId]/page.tsx
    result/[sessionId]/page.tsx
  admin/eye-care/page.tsx
  api/
    eye/session/start/route.ts
    eye/result/upsert/route.ts
    eye/event/route.ts
    consult/request/route.ts
lib/
  supabase/
    client.ts
    server.ts (사용 시 최소화/안정화)
components/
  eye-care/
    Landing.tsx
    TestShell.tsx
    GateBlurCard.tsx
    ResultReport.tsx
    ScoreGauge.tsx
    DisclaimerSticky.tsx
utils/
  scoring/
    condition.ts
    dryness.ts
    pattern.ts
    strain.ts
    lifestyle.ts

---

## 13. 비고(권장)
- Phase 1은 “정확도”가 아니라 “참여/전환” 검증이 목표
- 카메라 기반(OpenCV.js)은 이슈가 많으므로 **옵션으로 남기고**, 설문/터치 기반으로도 완주 가능하게 설계
- “가짜 로딩”은 사용하되 **허위 지표(상위 10%, 32지표 분석)** 문구는 금지

---
(끝)
