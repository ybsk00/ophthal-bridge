# 메디컬 영역: 가상 시뮬레이션 4종 (PC 전후 사진 / 카메라 가능 시 Live) 구현 계획서

## 0) 목표
로그인 이후(메디컬 영역)에서 **시야 체감 엔진을 재사용**하여 4개의 “가상 시뮬레이션 체험” 메뉴를 제공한다.  
- **PC 기본:** 샘플 이미지 기반 **전/후(Before/After) 클릭 비교**
- **카메라 가능 시:** **Live(웹캠/카메라) 실시간 체험**
- 저장은 이미지가 아니라 **설정값(JSON)**만 저장한다.

> 안내 문구(고정)
- “본 시뮬레이션은 이해를 돕기 위한 참고용 예시이며, 실제 상태·결과를 확정하거나 보장하지 않습니다.”
- “촬영/이미지는 저장하지 않습니다. 저장되는 값은 설정값입니다.”

---

## 1) 메뉴 구성 (4종)
메디컬 영역의 2×2 카드 메뉴로 제공한다. (기존 UI 재사용)

1) **선명도 체감**  
- 설명: 글자/경계가 또렷하게 느껴지는 정도 비교  
- 기본 프리셋 방향: blur ↓, contrast ↑

2) **대비 체감**  
- 설명: 대비 변화로 경계/글자가 덜 또렷해지는 느낌 체감  
- 기본 프리셋 방향: contrast ↓, gamma/midtone 조정

3) **야간 빛 번짐 체감**  
- 설명: 불빛 번짐(헤일로/눈부심) 느낌을 단계별로 비교  
- 기본 프리셋 방향: glare ↑, bloom ↑

4) **시야 패턴 체감**  
- 설명: 가림/번짐/왜곡 등 불편 패턴 예시를 선택해 체감  
- 기본 프리셋 방향: mask(위치/크기) + mild blur/warp(옵션)

카드 짧은 문구(옵션)
- 선명도 체감: “또렷함 비교”
- 대비 체감: “경계·글자 대비”
- 야간 빛 번짐 체감: “불빛 번짐 느낌”
- 시야 패턴 체감: “불편 패턴 예시”

---

## 2) 디바이스별 제공 방식 (핵심 규칙)
### 2.1 PC 기본: 전/후 클릭 비교 (Sample 기반)
- 기본 모드: `mode="sample"`
- 화면 구성:
  - 상단: 샘플 탭(야간 도로/글자·간판/실내 화면/밝은 야외)
  - 중앙: **Before/After 토글**
    - Before: 원본 샘플
    - After: 현재 프리셋/슬라이더 적용 결과
  - 하단: 프리셋 버튼 + 슬라이더 + 초기화
- UX:
  - “전/후 보기” 버튼은 **클릭/홀드** 모두 지원(가능하면)
  - Sample 모드는 **슬라이더 변경 시에만 drawOnce** (rAF 루프 금지)

### 2.2 카메라 가능 시: Live 모드 제공 (선택)
- “웹캠(카메라)로 체험하기” 버튼 제공
- 권한 허용 성공 → `mode="live"`로 전환
- Live 모드에서는:
  - Before/After 토글은 선택사항
    - 권장: After만 표시(실시간)
    - 옵션: Before(원본) / After(필터) 토글 또는 좌/우 분할

### 2.3 실패/거부 시: Sample 유지
- 카메라 실패 시 자동으로 Sample 유지
- 사유 안내(간단)
  - 권한 거부 / 장치 없음 / 보안 정책 / HTTPS 미지원 등

---

## 3) 공통 컨트롤(엔진 재사용)
### 3.1 프리셋 4종 (공통)
- `clear` / `blur` / `glare` / `mist`

### 3.2 슬라이더 3개(공통)
- blur (0~1)
- glare (0~1)
- contrast (-0.3~0.3)

### 3.3 추가 옵션(시야 패턴 체감 전용)
- maskType: none | centerSpot | sideBlur | partialBlock
- maskSize: 0~1
- maskPosition: x,y (0~1)

---

## 4) 상태/타입 정의
`src/lib/vision/vision-types.ts`
```ts
export type VisionMode = "sample" | "live";
export type VisionPreset = "clear" | "blur" | "glare" | "mist";
export type VisionMenu = "clarity" | "contrast" | "nightGlare" | "pattern";

export interface VisionState {
  mode: VisionMode;
  menu: VisionMenu;
  preset: VisionPreset;
  blur: number;        // 0~1
  glare: number;       // 0~1
  contrast: number;    // -0.3~0.3
  sampleSrc?: string;  // public/samples/vision/*
  // pattern only
  maskType?: "none" | "centerSpot" | "sideBlur" | "partialBlock";
  maskSize?: number;   // 0~1
  maskX?: number;      // 0~1
  maskY?: number;      // 0~1
}
5) UI 컴포넌트 설계
5.1 메뉴 카드
MedicalSimulationMenu.tsx

2×2 카드

클릭 시 해당 메뉴로 진입(슬라이드오버 또는 페이지)

5.2 시뮬레이터 본체(재사용 핵심)
VisionSimulatorMedical.tsx

입력 소스:

sample: img

live: video (getUserMedia)

출력:

canvas 렌더(필터 적용)

구성:

샘플 탭(샘플 모드일 때)

Before/After 토글(PC 기본)

프리셋 버튼 + 슬라이더

초기화 + 다른 샘플

“웹캠으로 체험하기(선택)” 버튼

5.3 Before/After 동작(PC 기본)
view="before" | "after"

before: 원본 draw

after: 필터 적용 draw

6) 샘플 이미지
경로: public/samples/vision/

street_night.jpg (야간 도로)

text_board.jpg (글자/간판)

office_screen.jpg (실내 화면)

street_day.jpg (밝은 야외)

규칙

브랜드/로고/읽을 수 있는 텍스트 없음

의료/병원 연상 요소 없음

용량 300~800KB 권장

7) 저장(로그인 이후) 정책
7.1 저장 데이터(설정값만)
이미지, 프레임, base64 저장 금지

저장 payload 예시:

json
코드 복사
{
  "menu": "nightGlare",
  "mode": "sample",
  "sampleSrc": "/samples/vision/street_night.jpg",
  "preset": "glare",
  "blur": 0.15,
  "glare": 0.55,
  "contrast": 0.05,
  "pattern": { "maskType": "none" }
}
7.2 저장 위치
Supabase DB: medical_simulation_settings (권장 신규)

또는 기존 eye_test_results.summary에 포함(JSONB)

8) 이벤트(메디컬 영역 KPI/QA)
필수 이벤트

simulation_menu_view { menu }

simulation_open { menu, initial_mode }

simulation_mode_switch { from, to, reason }

simulation_before_after_toggle { view }

simulation_preset_change { preset }

simulation_slider_change { blur, glare, contrast } (디바운스 1초)

simulation_save_click

simulation_save_success

9) 파일 구조(권장)
src/
├── app/
│ └── medical/
│ └── simulation/ # [NEW] 메디컬 시뮬레이션
│ └── page.tsx
├── components/
│ └── medical/
│ ├── MedicalSimulationMenu.tsx
│ └── VisionSimulatorMedical.tsx
├── lib/
│ └── vision/
│ ├── vision-types.ts
│ ├── presets.ts # 메뉴별 기본값/프리셋 매핑
│ └── renderer.ts # canvas draw: sample/live 공통
└── public/
└── samples/vision/
├── street_night.jpg
├── text_board.jpg
├── office_screen.jpg
└── street_day.jpg

10) Verification Plan
10.1 PC(웹캠 없음)
시뮬레이터 진입 → 샘플 기본 렌더 확인

전/후 토글 정상 동작 확인

프리셋/슬라이더 변경 시 즉시 반영 확인(drawOnce)

저장 버튼 클릭 → 설정값 저장 확인

10.2 PC(웹캠 있음)
“웹캠으로 체험하기” → 권한 허용 → live 전환 확인

live에서 프리셋/슬라이더 반영 확인(rAF)

모달 닫기 시 트랙 stop() 확인

10.3 모바일(후면 카메라 권장)
live 체험 가능 여부 확인

성능(프레임 드랍/발열) 확인

네비게이션/백그라운드 복귀 시 안정성 확인

11) 구현 우선순위(빠른 MVP)
MedicalSimulationMenu + VisionSimulatorMedical(샘플 모드 + 전/후) 완성

프리셋/슬라이더 연결 + 메뉴별 기본값(presets.ts) 적용

웹캠 live 전환(선택) + 실패 사유 처리

설정값 저장(API/DB) + 이벤트 기록

QA(PC/모바일) 및 문구 최종 점검