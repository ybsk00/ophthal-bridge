# 4개 메뉴(결·톤 정돈 / 표정주름 완화 / 볼륨감 변화 / 광채·물광) Hybrid 변환 구현 계획 (Sharp + Nano Banana Pro)

목적: 로그인 이후 사용자가 사진 업로드 후 4개 메뉴를 선택하면, 각 메뉴별로 **최적의 엔진(Sharp vs Nano Banana Pro)**을 사용해 “참고용 시각화” 이미지를 생성한다.  
원칙: 동일 인물/배경 유지, 과장 최소화, “시술 결과 예측/보장” 금지(참고용 고지 상시).

---

## 1) 하이브리드 아키텍처 개요

### 1-1. Provider 추상화
서버에서 변환 엔진을 교체 가능하도록 Provider 계층을 만든다.

- `TransformProvider` 인터페이스
  - `transform(input: Buffer, ctx: TransformContext): Promise<Buffer>`

Provider 2종
- `SharpProvider`: 로컬 이미지 편집(빠름/안정/저비용)
- `NanoBananaProvider`: 외부 AI 편집(반전 강함/비용/지연/검수 필요)

### 1-2. 메뉴 → Provider 매핑(권장)
| 메뉴 | variant_key | Provider | 이유 |
|---|---|---|---|
| 결·톤 정돈 | `texture_tone` | **Sharp** | 톤/채도/명암/피부결 정돈은 필터 기반이 더 자연스럽고 안정적 |
| 표정주름 완화 | `wrinkle_soften` | **Nano Banana Pro** | 국소 주름 대비 완화는 AI 인페인트가 반전 체감이 큼(단, 과장 금지) |
| 볼륨감 변화 | `volume_expression` | **Nano Banana Pro(제한 모드)** | 형태변경이 아니라 “명암/조명으로 볼륨 표현” 수준에서 AI가 유리 |
| 광채/물광 | `glow` | **Sharp** | 하이라이트/커브/미드톤 조절로도 반전 충분, AI 사용 시 기름광/플라스틱 리스크 증가 |

---

## 2) 공통 처리 파이프라인 (모든 메뉴 공통)

### 2-1. 입력 이미지 전처리(서버)
- 이미지 포맷 통일: JPEG (품질 90, chroma subsampling 4:4:4 권장)
- 해상도 통일: 긴 변 기준 1536px 내외(성능/품질 균형)
- EXIF orientation 정리(회전/뒤집힘 방지)

### 2-2. 동일성/배경 유지 전략
- 기본 원칙: **원본을 바탕으로 편집(Edit)만 수행**
- Sharp는 원본 픽셀 기반이므로 배경 유지가 자연스럽다.
- Nano Banana는 반드시 아래 “가드레일”을 적용한다.
  - **배경/헤어/의상 변경 금지**
  - **얼굴 형태 변경 금지**
  - **스킨 텍스처 유지(블러 금지)**
  - 가능하면 **얼굴 ROI 마스크(선택)**를 함께 사용해 얼굴 부위만 편집 유도

### 2-3. 결과 품질 가드(후처리/검증)
- 결과가 과하게 바뀌는 경우를 방지하기 위한 간단한 자동 점검(권장)
  - 히스토그램/평균 밝기 변화가 과도(예: +25% 이상)하면 실패로 처리 또는 재시도
  - 얼굴 영역 외 배경 픽셀 변화가 크면 실패 처리(ROI 비교)
- 실패 시:
  - 해당 variant만 `failed`
  - 나머지 variant는 정상 생성 유지(부분 성공 허용)

---

## 3) 메뉴별 상세 변환 설계

## A. 결·톤 정돈 (texture_tone) — Sharp Provider
목표: “칙칙함 정리 + 미세 톤 균일화”를 자연스럽게 구현(과도한 미백/필터 금지)

### A-1. 적용 파라미터(예시)
- 밝기(Exposure): +3% ~ +7%
- 콘트라스트: +5% 내외
- 채도(Saturation): +3% 내외(과하면 화장 느낌)
- 화이트밸런스: 약간 따뜻하게(+2~3)
- 미세 선명도(Clarity): +3% (과하면 AI 느낌)

### A-2. Sharp 구현 힌트
- `modulate({ brightness, saturation })`
- `linear(a, b)`로 미드톤 조정
- 과한 노이즈 감소/블러 금지(피부결 유지)

---

## B. 표정주름 완화 표현 (wrinkle_soften) — Nano Banana Pro
목표: “주름이 사라짐”이 아니라 **주름 대비가 살짝 낮아진 듯한 표현**(실사 유지)

### B-1. 편집 범위(ROI)
- 눈가(까마귀발), 미간, 이마의 표정주름, 팔자 주변
- 가능하면 FaceMesh/랜드마크로 ROI 마스크 생성(권장)

### B-2. Nano Banana 프롬프트(권장 템플릿)
**SYSTEM(고정 가드레일)**
- Keep the same person and identity.
- Do not change background, hair, outfit.
- Do not reshape face or change facial proportions.
- Preserve pores and realistic skin texture.
- No beauty filter, no blur, no plastic skin.

**TASK(wrinkle_soften)**
- Reduce the contrast/depth of fine expression lines around eyes, forehead, glabella, and nasolabial area.
- Keep natural micro-texture and subtle lines (do not erase completely).
- Keep lighting consistent with the original.

**NEGATIVE**
- smooth skin, airbrushed, waxy, uncanny, different person, changed background, changed hairstyle

### B-3. 강도 제한(필수)
- “중” 기준으로만 제공(강은 숨김 또는 내부 테스트)
- 재시도 시 동일 인물 유지가 흔들리면 즉시 Sharp 기반 대체(폴백) 적용

---

## C. 볼륨감 변화 표현 (volume_expression) — Nano Banana Pro(제한 모드)
목표: **필러처럼 형태가 바뀌는 연출 금지.**  
“볼륨감 표현”은 **조명/명암으로 인상이 약간 달라 보이는 수준**으로 제한한다.

### C-1. 편집 범위(ROI)
- 볼(cheek) 상부 하이라이트
- 팔자 주변의 그림자 완화(아주 약하게)
- 턱선 그림자 정리(과하면 얼굴형 변경처럼 보임)

### C-2. Nano Banana 프롬프트(권장 템플릿)
**SYSTEM(고정 가드레일)**
- Keep the same person and identity.
- Do not change background, hair, outfit.
- Do not reshape face, do not change jawline/cheekbone structure.
- Preserve realistic texture, pores, and fine details.

**TASK(volume_expression)**
- Create a subtle impression of healthier facial volume using **lighting and shading only**.
- Slightly soften harsh shadows in mid-face (nasolabial and under-cheek shadow) without removing all definition.
- Add a gentle, natural highlight on upper cheeks (not glossy, not makeup).

**NEGATIVE**
- face reshape, cheek enlargement, jawline change, plastic skin, makeup look, over-bright

### C-3. 안전 장치(필수)
- 결과에서 얼굴 윤곽이 변형되면 실패 처리(자동 검증 또는 수동 QA)
- 실패 시 “Sharp 기반 명암 표현(폴백)”으로 대체 가능(추천)

---

## D. 광채/물광 (glow) — Sharp Provider
목표: 물광 반전은 크되, **기름광/플라스틱**처럼 보이지 않게 “작고 선명한 하이라이트”로 설계

### D-1. 적용 파라미터(예시)
- 미드톤 살짝 상승(+5% 내외)
- 하이라이트만 선택적으로 강화(전체 밝기 상승 금지)
- 포어 텍스처 유지(블러 금지)

### D-2. Sharp 구현 힌트(권장 접근)
- 전체 밝기 올리지 말고:
  - 커브(톤) 기반으로 mid/high만 조정
  - `sharpen`은 최소(과하면 AI 느낌)
- 하이라이트가 넓게 번지면 즉시 “기름광”이 되므로:
  - 하이라이트 범위 좁히고 강도는 조금 더 주는 방식으로 조정(“crisp highlight”)

---

## 4) 실행/오케스트레이션(서버)

### 4-1. generate 동작(요약)
1) sessionId로 original 다운로드
2) 4개 변환을 병렬 또는 제한 병렬(2개씩)로 실행
3) 각 결과를 storage 업로드
4) face_style_variants 업데이트(status, image_path)
5) face_style_sessions.status = ready
6) 실패 variant는 failed로 마킹하고, 세션은 “부분 성공”도 ready 처리(권장)

### 4-2. 폴백 전략(운영 안정)
- Nano Banana 실패/지연/결과 불안정 시:
  - `wrinkle_soften`: Sharp 기반 “국소 대비 완화”로 임시 대체(간단 버전)
  - `volume_expression`: Sharp 기반 “명암 표현”으로 임시 대체
- 폴백 적용 여부는 서버 설정 플래그로 제어:
  - `FACE_STYLE_AI_ENABLED=true/false`

---

## 5) 비용/성능 운영 기준(권장)

- Sharp: 즉시 처리(1~2초 내), 비용 거의 없음
- Nano Banana: 처리 시간 5~20초 가능, 호출 비용 발생
- 운영 정책:
  - Nano Banana 호출은 1세션당 최대 2회(2 variants)로 제한(지금 설계와 일치)
  - 동일 세션 재생성 버튼 제한(스팸 방지)
  - 실패 시 재시도는 최대 1회

---

## 6) QA 기준(반드시 통과)

### 6-1. 동일성
- 인물 동일성 유지(눈/코/입 비율 변화 X)
- 배경 변경 없음(픽셀 비교 시 차이 미미)

### 6-2. “AI스러움” 방지
- 피부가 플라스틱처럼 매끈하면 실패
- 과한 미백/과노출/과채도 실패
- 글리터/메이크업 룩 실패(본 서비스는 “표현” 중심)

### 6-3. 반전 체감
- 4개 중 최소 2개는 탭 전환 시 “눈에 띄는 차이”가 있어야 함
  - 보통 `glow`, `wrinkle_soften`에서 체감 확보

---

## 7) 최종 산출물(개발 산출)
- Provider 인터페이스 + SharpProvider + NanoBananaProvider
- 메뉴별 변환 파라미터/프롬프트 상수 분리
- generate 오케스트레이션(부분 성공/폴백/재시도 포함)
- 결과 품질 가드(간단 자동 검증) 적용
